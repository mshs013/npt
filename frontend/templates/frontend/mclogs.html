<!-- library/templates/library/mclogs.html -->
{% extends "core/base.html" %}
{% load static custom_tags custom_pagination i18n %}
{% block extra_css %}
    {{  block.super }}
    <link rel="stylesheet" href="{% static 'adminlte/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
{% endblock %}
{% block content_title %}Machine Logs{% endblock %}

{% block content_breadcrumb %}
    <li class="breadcrumb-item"><a href="#">Home</a></li>
    <li class="breadcrumb-item active">Machine Logs</li>
{% endblock %}

{% block content %}

<!-- Filter Panel -->
<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h3 class="card-title mb-0">
            <i class="fas fa-filter"></i> Filter Options
        </h3>
        <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <form method="GET" id="filterForm">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="machine" class="font-weight-bold">Machine:</label>
                        <select class="form-control" name="machine" id="machine">
                            <option value="">All Machines</option>
                            {% for machine in filter_machines %}
                                <option value="{{ machine.id }}" {% if request.GET.machine == machine|stringformat:'s' %}selected{% endif %}>
                                    {{ machine.mc_no }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="reason" class="font-weight-bold">Reason:</label>
                        <select class="form-control" name="reason" id="reason">
                            <option value="">All Reasons</option>
                            <option value="null">N/A</option>
                            {% for reason in filter_reasons %}
                                <option value="{{ reason.id }}" {% if request.GET.reason == reason.id|stringformat:'s' %}selected{% endif %}>
                                    {{ reason.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="shift" class="font-weight-bold">Shift:</label>
                        <select class="form-control" name="shift" id="shift">
                            <option value="">All Shifts</option>
                            {% for shift in filter_shifts %}
                                <option value="{{ shift.id }}" {% if request.GET.shift == shift.id|stringformat:'s' %}selected{% endif %}>
                                     {{ shift.name }} ({{ shift.start_time|time:"H:i" }} - {{ shift.end_time|time:"H:i" }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="datetime_from" class="font-weight-bold">From DateTime:</label>
                        <div class="input-group date" id="datetime_from" data-target-input="nearest">
                            <input type="text" class="form-control datetimepicker-input" data-toggle="datetimepicker" data-target="#datetime_from" name="datetime_from" value="{{ datetime_from }}">
                            <div class="input-group-append" data-target="#datetime_from" data-toggle="datetimepicker">
                                <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="datetime_to" class="font-weight-bold">To DateTime:</label>
                        <div class="input-group date" id="datetime_to" data-target-input="nearest">
                            <input type="text" class="form-control datetimepicker-input" data-toggle="datetimepicker" data-target="#datetime_to" name="datetime_to" value="{{ datetime_to }}">
                            <div class="input-group-append" data-target="#datetime_to" data-toggle="datetimepicker">
                                <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-group mb-0">
                            <button type="submit" class="btn btn-primary" >
                                <i class="fas fa-search"></i> Apply Filters
                            </button>
                            <a href="{% url 'view_mclog' %}" class="btn btn-secondary">
                                <i class="fas fa-undo"></i> Reset Filters
                            </a>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Use datetime inputs for precise filtering.
                        </small>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Machine Wise NPT Summary Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="bi bi-bar-chart-steps"></i> Machine Wise NPT Summary
            {% if current_shift %}({{ current_shift }}){% endif %}
        </h3>
    </div>
    <div class="card-body">
        {% if machines %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Machine</th>
                        {% for reason in reasons %}
                            <th>{{ reason.name }} ({{ reason.count }})</th>
                        {% endfor %}
                        <th>Total NPT ({{total_reason_counts}})</th>
                        <th>NPT (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for machine in machines %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ machine.name }}</td>
                        {% for reason in reasons %}
                            <td>
                                {% for machine_reason in machine.reasons %}
                                    {% if machine_reason.name == reason.name %}
                                        {{ machine_reason.duration }} 
                                    {% endif %}
                                {% empty %}
                                    0.00 min.00 min
                                {% endfor %}
                            </td>
                        {% endfor %}
                        <td>
                            {{machine.total_npt}} 
                        </td>
                        <td>
                           {{machine.npt_percentage}} %
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <td colspan="{{ footer_colspan }}">Total</td>
                        <td>{{ total_npt_all }} </td>
                        <td>{{ total_npt_percentage }} %</td>
                    </tr>
            </tfoot>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            No NPT summary data available for selected filters.
        </div>
        {% endif %}
    </div>
</div>

<!-- Machine NPT Log Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="bi bi-card-list"></i> Machine NPT Log
            {% if current_shift %}({{ current_shift }}){% endif %}
        </h3>
        <div class="card-tools">
                <a href="#" onclick="downloadExcel(); return false;" class="btn btn-success btn-sm">
                    <i class="fas fa-file-excel"></i> Download Excel
                </a>
        </div>
    </div>
    <div class="card-body">
        {% if page_obj %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered" id="nptTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Machine</th>
                        <th>Reason</th>
                        <th>Off Time</th>
                        <th>On Time</th>
                        <th>Duration </th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in page_obj %}
                    <tr>
                         <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                        <td>{{ record.machine.mc_no }}</td>
                        <td>{{ record.reason.name|default:"N/A" }}</td>
                        <td>{{ record.off_time|date:"M d, Y H:i" }}</td>
                        <td>
                            {% if record.on_time %}
                                {{ record.on_time|date:"M d, Y H:i" }}
                            {% else %}
                                <span class="text-muted">Still off</span>
                            {% endif %}
                        </td>
                        <td>{{ record.get_duration.total_seconds|floatformat:0 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-12">
            {% custom_pagination %}
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            No NPT records found for selected filters.
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
    {{  block.super }}
<script type="text/javascript" src="{% static 'adminlte/plugins/moment/moment.min.js' %}"></script>
<script type="text/javascript" src="{% static 'adminlte/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>

setInterval(() => {
    // Get current time
    const now = new Date();

    // Format it the same way your datetimepicker expects
    // (your config uses format: 'DD/MM/YYYY h:mm A')
    const formatted = moment(now).format('DD/MM/YYYY h:mm A');

    // Update the "To DateTime" input field
    document.querySelector('input[name="datetime_to"]').value = formatted;

    // Submit the filter form
    document.getElementById("filterForm").submit();

}, 60000); // 60 seconds


function downloadExcel() {
    const table = document.getElementById('nptTable');
    
    // Check if table exists and has data
    if (!table) {
        alert('No table found to export!');
        return;
    }
    
    const rows = table.querySelectorAll('tbody tr');
    if (rows.length === 0) {
        alert('No data to export! Please adjust your filters.');
        return;
    }
    
    try {
        // Create workbook from table
        const wb = XLSX.utils.table_to_book(table, {
            sheet: "NPT_Logs",
            raw: true,
            cellStyles: true
        });
        
        // Get the worksheet
        const ws = wb.Sheets["NPT_Logs"];
        console.log(ws)
        // Set column widths to prevent ##### display
        const colWidths = [
            { wch: 5 },   // # column
            { wch: 30 },  // Machine column
            { wch: 20 },  // Reason column
            { wch: 20 },  // Off Time column
            { wch: 20 },  // On Time column
            { wch: 15 }   // Duration column
        ];
        ws['!cols'] = colWidths;
        
        // Generate filename with current date
        const now = new Date();
        const dateStr = now.getFullYear() + '-' + 
                       String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(now.getDate()).padStart(2, '0');
        const filename = `npt_logs_${dateStr}.xlsx`;
        
        // Download the file
        XLSX.writeFile(wb, filename);
        
        console.log('Excel file downloaded successfully with proper column widths!');
    } catch (error) {
        console.error('Error creating Excel file:', error);
        alert('Error creating Excel file. Please try again.');
    }
}

        $(document).ready(function () {
            const now = new Date();
            $('#datetime_from').datetimepicker({ 
                //defaultDate: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 6, 0, 0),
                icons: { time: 'far fa-clock' },
                format: 'DD/MM/YYYY h:mm A',
            });
            $('#datetime_to').datetimepicker({
                useCurrent: false,
                //defaultDate: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 5, 59, 59),
                icons: { time: 'far fa-clock' },
                format: 'DD/MM/YYYY h:mm A',
            });
            $("#datetime_from").on("change.datetimepicker", function (e) {
                $('#datetime_to').datetimepicker('minDate', e.date);
            });
            $("#datetime_to").on("change.datetimepicker", function (e) {
                $('#datetime_from').datetimepicker('maxDate', e.date);
            });
        });

</script>
{% endblock %}