{% extends "core/base.html" %}
{% load static %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'adminlte/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
{% endblock %}

{% block content_title %}Daily Performance{% endblock %}

{% block content_breadcrumb %}
    <li class="breadcrumb-item"><a href="#">Home</a></li>
    <li class="breadcrumb-item active">Daily Performance</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Filter Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i class="fas fa-filter"></i> Filter Options
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form method="GET" id="filterForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="machine">Machine:</label>
                                <select class="form-control" name="machine" id="machine">
                                    <option value="">All Machines</option>
                                    {% for machine in filter_machines %}
                                        <option value="{{ machine }}" {% if request.GET.machine == machine|stringformat:'s' %}selected{% endif %}>
                                            {{ machine }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="reason">Reason:</label>
                                <select class="form-control" name="reason" id="reason">
                                    <option value="">All Reasons</option>
                                    {% for reason in filter_reasons %}
                                        <option value="{{ reason.id }}" {% if request.GET.reason == reason.id|stringformat:'s' %}selected{% endif %}>
                                            {{ reason.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="shift">Shift:</label>
                                <select class="form-control" name="shift" id="shift">
                                    <option value="">All Shifts</option>
                                    {% for shift in filter_shifts %}
                                        <option value="{{ shift.id }}" {% if request.GET.shift == shift.id|stringformat:'s' %}selected{% endif %}>
                                            {{ shift }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Apply Filters
                                    </button>
                                    <a href="{% url 'view_dailyperformance' %}" class="btn btn-secondary">
                                        <i class="fas fa-undo"></i> Reset
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="datetime_from" class="font-weight-bold">From DateTime:</label>
                                <div class="input-group date" id="datetime_from" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" data-toggle="datetimepicker" data-target="#datetime_from" name="datetime_from" value="{{ datetime_from }}">
                                    <div class="input-group-append" data-target="#datetime_from" data-toggle="datetimepicker">
                                        <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="datetime_to" class="font-weight-bold">To DateTime:</label>
                                <div class="input-group date" id="datetime_to" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" data-toggle="datetimepicker" data-target="#datetime_to" name="datetime_to" value="{{ datetime_to }}">
                                    <div class="input-group-append" data-target="#datetime_to" data-toggle="datetimepicker">
                                        <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Machine Wise NPT Summary -->
        <div class="card mb-4">
            <div class="p-2 d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> Machine Wise NPT Summary
                    {% if current_shift %}({{ current_shift }}){% endif %}
                </h3>
                <a href="#" onclick="downloadSummaryExcel(); return false;" class="btn btn-success btn-sm">
                    <i class="fas fa-file-excel"></i> Download Excel
                </a>
            </div>
            <div class="card-body p-0">
                {% if machines %}
                <div class="table-responsive">
                    <table id="summaryTable" class="table table-striped table-bordered mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>#</th>
                                <th>Machine</th>
                                <th>NPT</th>
                                <th>Total Events</th>
                                <th>Avg NPT per Event</th>
                                <th>Most NPT Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for machine in machines %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ machine.name }}</td>
                                <td>{{ machine.total_npt }}</td>
                                <td>{{ machine.total_events }}</td>
                                <td>{{ machine.avg_npt_per_event }}</td>
                                <td>{{ machine.most_npt_reason.name }} ({{ machine.most_npt_reason.duration }} min)</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="thead-dark">
                            <tr>
                                <td colspan="2" class="text-right font-weight-bold">Total</td>
                                <td class="font-weight-bold">{{ total_npt_all|floatformat:2 }} min</td>
                                <td class="font-weight-bold">{{ total_reason_counts }}</td>
                                <td class="font-weight-bold">{{ total_avg_npt_per_events }} min</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info m-0 rounded-0">
                    <i class="fas fa-info-circle"></i>
                    No NPT summary data available for selected filters.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Performance Charts Section -->
<div class="row">
    <div class="col-12">
        <!-- Bar Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i class="fas fa-chart-column"></i> NPT Performance Bar Chart
                </h3>
            </div>
            <div class="card-body">
                {{ bar_chart_html|safe }}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Pie Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i> NPT Distribution Pie Chart
                </h3>
            </div>
            <div class="card-body">
                {{ pie_chart_html|safe }}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Donut Charts -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i class="fas fa-chart-simple"></i> Machine-wise NPT Breakdown
                </h3>
            </div>
            <div class="card-body">
                {{ donut_charts_html|safe }}
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
    {{ block.super }}
<script type="text/javascript" src="{% static 'adminlte/plugins/moment/moment.min.js' %}"></script>
<script type="text/javascript" src="{% static 'adminlte/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
function downloadSummaryExcel() {
    const table = document.getElementById('summaryTable');
    
    if (!table) {
        alert('No summary table found to export!');
        return;
    }
    
    const rows = table.querySelectorAll('tbody tr');
    if (rows.length === 0) {
        alert('No data to export! Please adjust your filters.');
        return;
    }
    
    try {
        const wb = XLSX.utils.table_to_book(table, {
            sheet: "NPT_Summary",
            raw: true,
            cellStyles: true
        });
        
        const ws = wb.Sheets["NPT_Summary"];
        
        const colWidths = [
            { wch: 5 },
            { wch: 15 },
            { wch: 12 },
            { wch: 15 },
            { wch: 18 },
            { wch: 30 }
        ];
        ws['!cols'] = colWidths;
        
        const now = new Date();
        const dateStr = now.getFullYear() + '-' + 
                       String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(now.getDate()).padStart(2, '0');
        const filename = `npt_summary_${dateStr}.xlsx`;
        
        XLSX.writeFile(wb, filename);
        
        console.log('Summary Excel file downloaded successfully!');
    } catch (error) {
        console.error('Error creating Excel file:', error);
        alert('Error creating Excel file. Please try again.');
    }
}

$(document).ready(function () {
    const now = new Date();
    $('#datetime_from').datetimepicker({ 
        icons: { time: 'far fa-clock' },
        format: 'DD/MM/YYYY h:mm A',
    });
    $('#datetime_to').datetimepicker({
        useCurrent: false,
        icons: { time: 'far fa-clock' },
        format: 'DD/MM/YYYY h:mm A',
    });
    $("#datetime_from").on("change.datetimepicker", function (e) {
        $('#datetime_to').datetimepicker('minDate', e.date);
    });
    $("#datetime_to").on("change.datetimepicker", function (e) {
        $('#datetime_from').datetimepicker('maxDate', e.date);
    });
});
</script>
{% endblock %}